<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Registration</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { width: 400px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        .row { display: flex; gap: 10px; }
        button { width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; margin-top: 10px; }
        button:hover { background: #2980b9; }
        #otp-section { display: none; margin-top: 15px; padding: 15px; background: #e8f4fd; border: 1px dashed #3498db; border-radius: 8px; }
        .pass-hint { font-size: 10px; color: #e53935; margin-top: -5px; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

<div class="card">
    <h2>Patient Register</h2>
    <form id="patientForm">
        <input type="text" id="p_name" placeholder="Full Name" required>
        
        <div class="row">
            <input type="number" id="p_age" placeholder="Age" required style="flex: 1;">
            <select id="p_gender" required style="flex: 1;">
                <option value="" disabled selected>Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
        </div>

        <input type="text" id="p_aadhar" placeholder="Aadhar Number (12 Digits)" maxlength="12" required>
        
        <input type="password" id="password" placeholder="Create Password" required>
        <span class="pass-hint">Min 8 chars, 1 Number & 1 Symbol (@#$%^&*)</span>
        <input type="password" id="confirm_password" placeholder="Confirm Password" required>
        
        <input type="email" id="email" placeholder="Email Address" required>

        <div id="otp-section">
            <input type="text" id="otp_input" placeholder="Enter 4-digit OTP">
        </div>

        <button type="button" id="actionBtn" onclick="handleRegistration()">Send OTP</button>
    </form>
</div>

<script>
let currentStep = 1;

// --- üõ°Ô∏è Password Strength Checker ---
function isStrongPassword(password) {
    const minLength = 8;
    const hasNumber = /\d/;
    const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/;
    
    if (password.length < minLength) return "Password kam se kam 8 digit ka hona chahiye!";
    if (!hasNumber.test(password)) return "Password mein kam se kam ek number hona chahiye!";
    if (!hasSpecialChar.test(password)) return "Password mein kam se kam ek special character (e.g. @, #, $) hona chahiye!";
    return true;
}

function handleRegistration() {
    const pass = document.getElementById('password').value;
    const cPass = document.getElementById('confirm_password').value;
    const email = document.getElementById('email').value;

    if (currentStep === 1) {
        // Password matching check
        if (pass !== cPass) {
            alert("Passwords match nahi ho rahe!");
            return;
        }

        // Strength check call
        const strengthCheck = isStrongPassword(pass);
        if (strengthCheck !== true) {
            alert(strengthCheck);
            return;
        }

        fetch('/send-otp-only', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: email, password: pass, confirm_password: cPass,
                role: 'patient', patient_name: document.getElementById('p_name').value,
                aadhar: document.getElementById('p_aadhar').value
            })
        })
        .then(response => {
            if (response.ok) {
                document.getElementById('otp-section').style.display = 'block';
                document.getElementById('actionBtn').innerText = 'Verify & Register';
                currentStep = 2;
                alert("OTP Sent!");
            }
        });
    } else {
        const otpValue = document.getElementById('otp_input').value;
        fetch('/verify-and-register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ otp: otpValue })
        })
        .then(response => {
            if (response.ok) {
                alert("Success!");
                window.location.href = '/login';
            } else {
                alert("Galat OTP!");
            }
        });
    }
}
</script>
</body>
</html>