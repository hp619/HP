<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hospital Admin</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
body { background:#fdfdfd; padding-bottom:80px; font-family:'Segoe UI',sans-serif; }
.nav-bottom {
    position:fixed; bottom:0; width:100%;
    background:#212529; display:flex; justify-content:space-around;
    padding:12px 0; z-index:1000;
}
.nav-item {
    flex:1; text-align:center; color:#aaa;
    font-size:11px; border:none; background:none;
}
.nav-item i { font-size:22px; display:block; }
.nav-item.active { color:#ffc107; font-weight:bold; }
.badge-dot {
    position:absolute; top:5px; right:30%;
    background:red; color:white;
    font-size:10px; padding:2px 6px; border-radius:50%;
}
.content-section { display:none; animation:fadeIn .4s; }
.active-section { display:block; }
@keyframes fadeIn {
    from {opacity:0; transform:translateY(10px);}
    to {opacity:1; transform:translateY(0);}
}
.header-hos {
    background:#212529; color:#ffc107;
    padding:25px; border-radius:0 0 20px 20px;
}
.bed-card {
    background:#fff3cd; border:1px solid #ffeeba;
    border-radius:15px; padding:20px;
}

/* SOS Alert Style */
.emergency-card { border-left: 5px solid #dc3545 !important; animation: pulse-red 2s infinite; }
@keyframes pulse-red {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

/* NAYA STYLE: OTP Modal & Response Modal ke liye */
#otpOverlay, #responseOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); display: none; z-index: 2000;
    justify-content: center; align-items: center;
}
.otp-box { background: white; padding: 30px; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; }

/* Location Button Style */
.btn-location { background: #007bff; color: white; border: none; padding: 10px; border-radius: 8px; margin-bottom: 10px; width: 100%; }
.location-success { color: #28a745; font-weight: bold; font-size: 12px; display: none; }
</style>
</head>

<body>

<audio id="sirenAudio" loop>
    <source src="https://www.soundjay.com/buttons/sounds/beep-01a.mp3" type="audio/mpeg">
</audio>

<div id="hos-home" class="content-section active-section">
    <div class="header-hos text-center">
        <h3>{{ hospital.hospital_name }}</h3>
        <p class="mb-0 text-white small">
            Hospital ID: <b>{{ hospital.user_id }}</b>
        </p>
    </div>

    <div class="container mt-4">
        <div class="bed-card text-center shadow-sm mb-4">
            <h2 class="text-warning">{{ hospital.beds_available or 0 }}</h2>
            <p class="mb-0 fw-bold">Beds Currently Available</p>
        </div>

        <div class="card shadow-sm border-0 p-3">
            <h5 class="text-success">
                <i class="fa fa-user-check"></i> Patients Selected Your Hospital
            </h5>
            <hr>
            <div id="selectedPatientsList">
                {% if selected_patients %}
                    {% for p in selected_patients %}
                    <div class="alert alert-light border d-flex justify-content-between align-items-center">
                        <div>
                            <b>{{ p.patient_name }}</b><br>
                            <small class="text-muted">{{ p.problem }}</small>
                        </div>
                        <button class="btn btn-sm btn-warning">Assign Specialist</button>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted small text-center">No patient has selected your hospital yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div id="hos-alerts" class="content-section">
    <div class="p-4">
        <h4 class="text-danger"><i class="fa fa-bell"></i> Emergency Requests (Within 10km)</h4>
        <hr>
        <div id="sosAlertsContainer">
            <p class="text-muted text-center">Monitoring for active emergency requests...</p>
        </div>
    </div>
</div>

<div id="responseOverlay">
    <div class="otp-box shadow">
        <h5 class="text-success">Accepting Emergency</h5>
        <p class="small text-muted">Bataiye kaunsa doctor available hai?</p>
        <input type="hidden" id="current_sos_id">
        <div class="mb-3 text-start">
            <label class="small fw-bold">Specialist Available:</label>
            <input type="text" id="resp_specialist" class="form-control" placeholder="e.g. Cardiologist">
        </div>
        <div class="mb-3 text-start">
            <label class="small fw-bold">Free Beds (Emergency):</label>
            <input type="number" id="resp_beds" class="form-control" value="1">
        </div>
        <button onclick="submitSOSResponse()" class="btn btn-success w-100 mb-2">Send Response to Patient</button>
        <button onclick="document.getElementById('responseOverlay').style.display='none'" class="btn btn-link text-muted">Cancel</button>
    </div>
</div>

<div id="hos-profile" class="content-section">
<div class="p-4">
<h4><i class="fa fa-building text-warning"></i> Hospital Profile</h4>
<hr>

<div class="card p-3 shadow-sm border-0">
    <div class="mb-3">
        <label class="fw-bold text-primary">GPS Location Settings</label>
        <button type="button" onclick="getBrowserLocation()" class="btn-location">
            <i class="fa fa-map-marker-alt"></i> Update My GPS Location
        </button>
        <p id="location-text" class="location-success text-center">âœ… GPS Coordinates Captured!</p>
        <input type="hidden" id="h_lat" value="{{ hospital.location.coordinates[1] if hospital.location else '' }}">
        <input type="hidden" id="h_lng" value="{{ hospital.location.coordinates[0] if hospital.location else '' }}">
        <small class="text-muted d-block text-center" style="font-size: 10px;">Click this to ensure patients can find you on the map.</small>
    </div>
    <hr>

    <div class="mb-3">
        <label class="text-muted small">Hospital ID</label>
        <input class="form-control bg-light" value="{{ hospital.user_id }}" readonly>
    </div>

    <div class="mb-3">
        <label>Hospital Name</label>
        <input id="h_name" class="form-control" value="{{ hospital.hospital_name }}">
    </div>

    <div class="mb-3">
        <label>Address</label>
        <textarea id="h_address" class="form-control">{{ hospital.address }}</textarea>
    </div>

    <div class="mb-3">
        <label>Email</label>
        <input id="h_email" class="form-control" value="{{ hospital.email }}">
    </div>

    <div class="mb-3">
        <label>Phone</label>
        <input id="h_phone" class="form-control" value="{{ hospital.phone }}">
    </div>

    <div class="mb-3">
        <label class="text-primary fw-bold">Beds Available</label>
        <input id="h_beds" type="number" class="form-control border-primary" value="{{ hospital.beds_available }}">
    </div>

    <button onclick="requestHospitalOTP()" class="btn btn-warning w-100">
        Verify & Save Changes
    </button>

    <hr>
    <a href="/logout" class="btn btn-danger w-100"><i class="fa fa-power-off"></i> Logout</a>
</div>
</div>
</div>

<div id="otpOverlay">
    <div class="otp-box shadow">
        <h4>Email Verification</h4>
        <p class="small text-muted">Aapki email par OTP bheja gaya hai.</p>
        <input type="text" id="otp_code" class="form-control mb-3 text-center" placeholder="Enter 4-Digit OTP" style="font-size: 20px; letter-spacing: 5px;">
        <button onclick="verifyHospitalUpdate()" class="btn btn-success w-100 mb-2">Confirm Update</button>
        <button onclick="document.getElementById('otpOverlay').style.display='none'" class="btn btn-link text-muted">Cancel</button>
    </div>
</div>

<div class="nav-bottom">
    <button onclick="hosTab(this,'hos-home')" class="nav-item active"><i class="fa fa-th-large"></i>Dash</button>
    <button onclick="hosTab(this,'hos-alerts')" class="nav-item position-relative">
        <i class="fa fa-bullhorn"></i>Alerts
        <span id="alertBadge" class="badge-dot" style="display:none;">!</span>
    </button>
    <button onclick="hosTab(this,'hos-profile')" class="nav-item"><i class="fa fa-cog"></i>Profile</button>
</div>

<script>
function getBrowserLocation() {
    const locText = document.getElementById('location-text');
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            document.getElementById('h_lat').value = position.coords.latitude;
            document.getElementById('h_lng').value = position.coords.longitude;
            locText.style.display = "block";
            alert("Sahi hai! Browser ne aapki location pakad li hai. Ab 'Save Changes' par click karein.");
        }, (error) => {
            alert("Error: Location access denied. Please enable GPS.");
        });
    } else {
        alert("Browser does not support Geolocation.");
    }
}

function hosTab(el,id){
    document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active-section'));
    document.getElementById(id).classList.add('active-section');
    document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
    el.classList.add('active');
    
    if(id === 'hos-alerts') {
        document.getElementById('sirenAudio').pause();
        document.getElementById('alertBadge').style.display = 'none';
    }
}

function checkForEmergencies() {
    fetch('/hospital/check_emergencies')
    .then(res => res.json())
    .then(data => {
        const container = document.getElementById('sosAlertsContainer');
        const badge = document.getElementById('alertBadge');
        const siren = document.getElementById('sirenAudio');

        if(data.alerts && data.alerts.length > 0) {
            badge.style.display = 'block';
            if(document.getElementById('hos-alerts').classList.contains('active-section') === false) {
                 siren.play().catch(e => console.log("Audio play blocked"));
            }
            
            container.innerHTML = '';
            data.alerts.forEach(a => {
                const lat = a.location.coordinates[1];
                const lng = a.location.coordinates[0];
                const card = `
                <div class="card mb-3 emergency-card shadow-sm">
                    <div class="card-body">
                        <h6 class="text-danger fw-bold"><i class="fa fa-exclamation-triangle"></i> CRITICAL SOS (${a.sos_id})</h6>
                        <p class="mb-1"><b>Patient:</b> ${a.patient_name}</p>
                        <p class="mb-1"><b>Phone:</b> ${a.phone}</p>
                        <p class="mb-1"><b>Issue:</b> ${a.description || 'Medical Emergency'}</p>
                        <hr>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success flex-grow-1" onclick="openAcceptModal('${a.sos_id}')">Accept Case</button>
                            <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" class="btn btn-outline-primary"><i class="fa fa-map-marker-alt"></i> Location</a>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += card;
            });
        } else {
            container.innerHTML = '<p class="text-muted text-center mt-5">Monitoring for active emergency requests...</p>';
        }
    });
}

setInterval(checkForEmergencies, 5000);

// NAYA LOGIC: SOS Accept karne ke liye modal kholna
function openAcceptModal(sosId) {
    document.getElementById('current_sos_id').value = sosId;
    document.getElementById('responseOverlay').style.display = 'flex';
}

// NAYA LOGIC: Backend ko response bhejna
function submitSOSResponse() {
    const sosId = document.getElementById('current_sos_id').value;
    const specialist = document.getElementById('resp_specialist').value || 'Emergency Doctor';
    const beds = document.getElementById('resp_beds').value;

    fetch('/hospital/accept_sos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            sos_id: sosId,
            specialist_name: specialist,
            free_beds: beds
        })
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === 'success') {
            alert("Response sent! Patient can now see your hospital.");
            document.getElementById('responseOverlay').style.display = 'none';
        } else {
            alert("Error: " + data.message);
        }
    })
    .catch(err => alert("Server connection error"));
}

function requestHospitalOTP() {
    const latVal = document.getElementById('h_lat').value;
    const lngVal = document.getElementById('h_lng').value;

    const data = {
        hospital_name: document.getElementById('h_name').value,
        email: document.getElementById('h_email').value,
        phone: document.getElementById('h_phone').value,
        address: document.getElementById('h_address').value,
        beds_available: document.getElementById('h_beds').value,
        lat: latVal ? parseFloat(latVal) : null,
        lng: lngVal ? parseFloat(lngVal) : null
    };

    fetch('/hospital/request_update_otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(res => {
        if(res.status === 'sent') {
            document.getElementById('otpOverlay').style.display = 'flex';
        } else {
            alert("Error sending OTP!");
        }
    });
}

function verifyHospitalUpdate() {
    const otp = document.getElementById('otp_code').value;
    
    fetch('/hospital/verify_update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ otp: otp })
    })
    .then(res => res.json())
    .then(res => {
        if(res.status === 'success') {
            alert("Profile successfully update ho gayi!");
            window.location.reload();
        } else {
            alert("Incorrect OTP! Please try again.");
        }
    });
}
</script>

</body>
</html>