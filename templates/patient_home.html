<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body { background-color: #f0f2f5; padding-bottom: 80px; font-family: 'Segoe UI', sans-serif; }
        
        .header-bg { background: #212529; color: #ffc107; padding: 30px 20px; border-radius: 0 0 25px 25px; margin-bottom: 25px; border-bottom: 3px solid #ffc107; }
        
        .nav-bottom { position: fixed; bottom: 0; width: 100%; background: #212529; display: flex; justify-content: space-around; padding: 12px 0; border-top: 2px solid #333; z-index: 1000; }
        .nav-item { text-align: center; color: #888; text-decoration: none; font-size: 11px; flex: 1; border: none; background: none; transition: 0.3s; }
        .nav-item i { font-size: 22px; display: block; margin-bottom: 2px; }
        .nav-item.active { color: #ffc107; font-weight: bold; }

        .content-section { display: none; animation: fadeIn 0.4s; }
        .active-section { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-custom { border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; background: white; }
        
        .sos-circle { width: 120px; height: 120px; border-radius: 50%; background: #dc3545; color: white; border: 8px solid #f8d7da; font-weight: bold; font-size: 20px; box-shadow: 0 0 20px rgba(220, 53, 69, 0.4); display: flex; align-items: center; justify-content: center; margin: 20px auto; cursor: pointer; transition: 0.2s; }
        .sos-circle:active { transform: scale(0.9); }

        #otpOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 2000; justify-content: center; align-items: center; }
        .otp-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 380px; }

        .suggestion-box { position: absolute; width: 100%; background: white; z-index: 1050; border-radius: 0 0 10px 10px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); max-height: 400px; overflow-y: auto; display: none; }
        .suggestion-item { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .suggestion-item:hover { background: #f8f9fa; }
        
        .badge-live { background: #e7f3ff; color: #007bff; font-size: 10px; padding: 3px 8px; border-radius: 4px; border: 1px solid #b3d7ff; }
        .badge-govt { background: #f8f9fa; color: #6c757d; font-size: 10px; padding: 3px 8px; border-radius: 4px; border: 1px solid #dee2e6; }

        .hospital-response-card { border-left: 5px solid #28a745; animation: slideIn 0.3s; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .pulse-red { animation: pulse-red-anim 1.5s infinite; }
        @keyframes pulse-red-anim { 0% { box-shadow: 0 0 0 0px rgba(220, 53, 69, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0px rgba(220, 53, 69, 0); } }

        #sosMap { height: 250px; width: 100%; border-radius: 15px; margin-bottom: 20px; display: none; border: 2px solid #ffc107; }
        
        .dist-badge { background: #fff3cd; color: #856404; font-size: 12px; padding: 4px 8px; border-radius: 50px; border: 1px solid #ffeeba; }
        
        .stars-gold { color: #f1c40f; font-size: 13px; margin-left: 5px; }
    </style>
</head>
<body>

    <div id="home" class="content-section active-section">
        <div class="header-bg text-center">
            <h4>Namaste, {{ user.patient_name }}</h4>
            <p class="mb-0">Patient ID: <b>{{ user.user_id }}</b></p>
        </div>
        <div class="container">
            <div id="sosMap"></div>

            <div id="liveResponseArea" style="display: none;" class="mb-4">
                <h6 class="fw-bold text-danger mb-3"><i class="fa fa-circle-notch fa-spin"></i> Nearby Hospitals Responding...</h6>
                <div id="responseList"></div>
            </div>

            <div class="card card-custom p-4">
                <h6 class="fw-bold"><i class="fa fa-heartbeat text-danger"></i> My Quick Info</h6>
                <hr>
                <div class="d-flex justify-content-between mb-2"><span>Aadhar:</span> <b>{{ user.aadhar_no }}</b></div>
                <div class="d-flex justify-content-between mb-2"><span>Phone:</span> <b>{{ user.phone or 'Not Set' }}</b></div>
                <div class="d-flex justify-content-between"><span>Email:</span> <b>{{ user.email }}</b></div>
            </div>

            <div class="card card-custom p-4 border-start border-warning border-4">
                <h6 class="fw-bold"><i class="fa fa-info-circle text-warning"></i> Current Status</h6>
                <p id="sosAlertCount" class="small text-muted mb-0">No active emergency requests. Stay safe!</p>
            </div>
        </div>
    </div>

    <div id="search" class="content-section">
        <div class="p-4">
            <h4 class="fw-bold"><i class="fa fa-search text-primary"></i> All India Search</h4>
            <p class="text-muted small">Find verified partners or 2 Lakh+ Govt Health Centres across India.</p>
            <hr>
            <div class="position-relative">
                <div class="input-group mb-4 shadow-sm">
                    <input type="text" id="hospitalSearchInput" class="form-control" placeholder="Search Hospital, District or State..." onkeyup="searchHospitals(this.value)">
                    <button class="btn btn-warning"><i class="fa fa-search text-dark"></i></button>
                </div>
                <div id="suggestionBox" class="suggestion-box border"></div>
            </div>
            
            <div id="searchPlaceholder" class="bg-light p-5 text-center rounded-4 border">
                <i class="fa fa-map-marked-alt fa-3x text-muted mb-3"></i>
                <p class="text-muted">Type name (e.g. 'SMBT' or 'Pune') to search...</p>
            </div>
        </div>
    </div>

    <div id="request" class="content-section">
        <div class="p-4">
            <h4 class="fw-bold text-danger"><i class="fa fa-ambulance"></i> Emergency Broadcast</h4>
            <p class="text-muted small">Alert all hospitals within 10km radius immediately.</p>
            <hr>
            <div class="card card-custom p-4 text-center">
                <div id="sosButton" class="sos-circle shadow-lg" onclick="triggerSOS()">SOS</div>
                <p id="sosStatus" class="small text-danger fw-bold mt-2">TAP TO BROADCAST EMERGENCY</p>

                <form id="emergencyForm" class="text-start mt-4">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Problem/Description</label>
                        <textarea id="emergencyDesc" class="form-control" rows="3" placeholder="Describe the medical condition..."></textarea>
                    </div>
                    <button type="button" onclick="triggerSOS()" class="btn btn-danger w-100 fw-bold py-2 shadow-sm">SEND TO NEARBY HOSPITALS</button>
                </form>
            </div>
        </div>
    </div>

    <div id="profile" class="content-section">
        <div class="p-4">
            <h4 class="fw-bold"><i class="fa fa-user-circle text-success"></i> My Account</h4>
            <hr>
            <div class="card card-custom p-4 shadow-sm">
                <div class="text-center mb-4">
                    <div class="bg-light rounded-circle d-inline-block p-3 mb-2" style="width: 80px; height: 80px;">
                        <i class="fa fa-user fa-3x text-warning"></i>
                    </div>
                    <h5 class="fw-bold">{{ user.patient_name }}</h5>
                    <span class="badge bg-success">Verified Account</span>
                </div>

                <form id="profileForm">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Patient ID</label>
                        <input type="text" class="form-control bg-light" value="{{ user.user_id }}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Aadhar Number</label>
                        <input type="text" class="form-control bg-light" value="{{ user.aadhar_no }}" readonly>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Full Name</label>
                        <input type="text" id="new_name" class="form-control" value="{{ user.patient_name }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Email Address</label>
                        <input type="email" id="new_email" class="form-control" value="{{ user.email }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Phone Number</label>
                        <input type="text" id="new_phone" class="form-control" value="{{ user.phone or '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Gender</label>
                        <select id="new_gender" class="form-select">
                            <option value="Male" {% if user.gender == 'Male' %}selected{% endif %}>Male</option>
                            <option value="Female" {% if user.gender == 'Female' %}selected{% endif %}>Female</option>
                            <option value="Other" {% if user.gender == 'Other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>

                    <div class="mt-4 p-3 bg-light rounded-3">
                        <h6 class="fw-bold text-primary"><i class="fa fa-notes-medical"></i> Medical & Insurance</h6>
                        <hr>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Medical History</label>
                            <textarea id="new_history" class="form-control">{{ user.medical_history or '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Blood Group</label>
                            <select id="new_blood" class="form-select">
                                <option value="">Select</option>
                                <option value="A+" {% if user.blood_group == 'A+' %}selected{% endif %}>A+</option>
                                <option value="B+" {% if user.blood_group == 'B+' %}selected{% endif %}>B+</option>
                                <option value="O+" {% if user.blood_group == 'O+' %}selected{% endif %}>O+</option>
                                <option value="AB+" {% if user.blood_group == 'AB+' %}selected{% endif %}>AB+</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Insurance ID</label>
                            <input type="text" id="new_insurance" class="form-control" value="{{ user.insurance_no or '' }}">
                        </div>
                    </div>

                    <button type="button" onclick="requestUpdateOTP()" class="btn btn-dark w-100 btn-sm fw-bold py-2 mt-3">Verify & Update Profile</button>
                </form>

                <hr class="my-4">
                <a href="{{ url_for('auth_bp.logout') }}" class="btn btn-outline-danger w-100 fw-bold">
                    <i class="fa fa-power-off me-2"></i> EXIT / LOGOUT
                </a>
            </div>
        </div>
    </div>

    <div id="otpOverlay">
        <div class="otp-box shadow-lg">
            <h5 class="fw-bold">Security Verification</h5>
            <p class="small text-muted">Aapki email par 4-digit OTP bheja gaya hai.</p>
            <input type="text" id="p_otp_code" class="form-control text-center mb-3" placeholder="0 0 0 0" style="font-size: 24px; letter-spacing: 8px; font-weight: bold;">
            <button onclick="verifyPatientUpdate()" class="btn btn-success w-100 mb-2 py-2 fw-bold">Confirm & Save Changes</button>
            <button onclick="document.getElementById('otpOverlay').style.display='none'" class="btn btn-link text-muted btn-sm">Cancel</button>
        </div>
    </div>

    <div class="nav-bottom">
        <button onclick="changeTab(this, 'home')" class="nav-item active"><i class="fa fa-home"></i>Home</button>
        <button onclick="changeTab(this, 'search')" class="nav-item"><i class="fa fa-search"></i>Search</button>
        <button onclick="changeTab(this, 'request')" class="nav-item"><i class="fa fa-ambulance"></i>Request</button>
        <button onclick="changeTab(this, 'profile')" class="nav-item"><i class="fa fa-user"></i>Profile</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let responsePoller = null;
        let map = null;
        let markers = {}; 

        // --- PURANE UTILS (As it is) ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c).toFixed(1);
        }

        function calculateETA(distance) {
            return Math.round((distance / 40) * 60) + 5;
        }

        function initMap(lat, lng) {
            if (map) return;
            document.getElementById('sosMap').style.display = 'block';
            map = L.map('sosMap').setView([lat, lng], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker([lat, lng]).addTo(map).bindPopup("<b>Aapki Location</b>").openPopup();
        }

        // --- SMART SEARCH (Updated Logic) ---
        function searchHospitals(query) {
            const box = document.getElementById('suggestionBox');
            const placeholder = document.getElementById('searchPlaceholder');
            
            if(query.length < 2) {
                box.style.display = 'none';
                placeholder.style.display = 'block';
                return;
            }

            fetch(`/patient/search_hospitals?q=${query}`)
            .then(res => res.json())
            .then(data => {
                box.innerHTML = '';
                placeholder.style.display = 'none';
                
                if(data.length > 0) {
                    box.style.display = 'block';
                    data.forEach(hosp => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        
                        // Badge Selection
                        let badgeHtml = '';
                        if(hosp.is_registered) {
                            badgeHtml = `<span class="badge bg-warning text-dark">‚≠ê Partner</span><span class="stars-gold">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>`;
                        } else if(hosp.type === "Govt/Public") {
                            badgeHtml = `<span class="badge-govt"><i class="fa fa-university"></i> Govt PHC</span>`;
                        } else {
                            badgeHtml = `<span class="badge-live"><i class="fa fa-globe"></i> India Live</span>`;
                        }

                        div.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="fw-bold text-dark" style="font-size: 14px;">
                                    <i class="fa fa-hospital text-danger me-1"></i> ${hosp.name}
                                </div>
                                ${badgeHtml}
                            </div>
                            <div class="small text-muted" style="font-size: 12px;">${hosp.address}</div>
                        `;

                        div.onclick = () => {
                            if(hosp.is_registered) {
                                // Registered hospital -> Go to Info/Review page
                                window.location.href = `/patient/hospital-info/${hosp.id}`;
                            } else {
                                // CSV or Google Hospital -> Open Google Maps with Lat/Lng or Name
                                let url = '';
                                if(hosp.lat && hosp.lng) {
                                    url = `https://www.google.com/maps/search/?api=1&query=${hosp.lat},${hosp.lng}`;
                                } else {
                                    url = `https://www.google.com/search?q=${encodeURIComponent(hosp.name + " " + hosp.address)}`;
                                }
                                window.open(url, '_blank');
                            }
                        };
                        box.appendChild(div);
                    });
                } else {
                    box.innerHTML = '<div class="p-3 text-center text-muted">No hospitals found matching this name.</div>';
                    box.style.display = 'block';
                }
            });
        }

        // --- SOS POLLING & BROADCAST (As it is) ---
        function startResponsePolling(sosId, userLat, userLng) {
            if(responsePoller) clearInterval(responsePoller);
            if(userLat && userLng) initMap(userLat, userLng);
            
            responsePoller = setInterval(() => {
                fetch(`/patient/get_sos_responses?sos_id=${sosId}`)
                .then(res => res.json())
                .then(data => {
                    if(data.hospitals && data.hospitals.length > 0) {
                        const area = document.getElementById('liveResponseArea');
                        const list = document.getElementById('responseList');
                        area.style.display = 'block';
                        list.innerHTML = '';
                        
                        data.hospitals.forEach(resp => {
                            const dist = calculateDistance(userLat, userLng, resp.lat, resp.lng);
                            const eta = calculateETA(dist);

                            if(map && resp.lat && resp.lng && !markers[resp.hospital_id]) {
                                markers[resp.hospital_id] = L.marker([resp.lat, resp.lng]).addTo(map).bindPopup(resp.hospital_name);
                            }

                            list.innerHTML += `
                                <div class="card card-custom p-3 hospital-response-card shadow-sm mb-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="fw-bold mb-0 text-dark">${resp.hospital_name}</h6>
                                        <span class="dist-badge">${dist} KM</span>
                                    </div>
                                    <p class="small text-muted mt-2 mb-2">ETA: <b>${eta} mins</b> | Doctor: <b>${resp.specialist_name}</b></p>
                                    <div class="d-flex gap-2">
                                        <button onclick="window.location.href='/patient/hospital-info/${resp.hospital_id}'" class="btn btn-sm btn-outline-primary flex-grow-1">INFO</button>
                                        <button onclick="selectHospital('${sosId}', '${resp.hospital_id}')" class="btn btn-sm btn-dark flex-grow-1">CHOOSE</button>
                                    </div>
                                </div>
                            `;
                        });
                    }
                });
            }, 3000); 
        }

        function triggerSOS() {
            if (confirm("üö® EMERGENCY! Alert hospitals?")) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((pos) => {
                        fetch('/patient/broadcast_emergency', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                lat: pos.coords.latitude, lng: pos.coords.longitude,
                                description: document.getElementById('emergencyDesc').value || "Urgent!"
                            })
                        })
                        .then(res => res.json())
                        .then(res => {
                            if(res.status === 'success') {
                                alert(`‚úÖ Alert Sent to ${res.found} hospitals.`);
                                changeTab(document.querySelector('.nav-item'), 'home');
                                startResponsePolling(res.sos_id, pos.coords.latitude, pos.coords.longitude);
                            }
                        });
                    });
                }
            }
        }

        function selectHospital(sosId, hospId) {
            fetch('/patient/final_selection', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sos_id: sosId, hospital_id: hospId })
            }).then(() => location.reload());
        }

        function changeTab(element, sectionId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active-section'));
            document.getElementById(sectionId).classList.add('active-section');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            element.classList.add('active');
        }

        // --- PROFILE LOGIC (As it is) ---
        function requestUpdateOTP() {
            const data = {
                name: document.getElementById('new_name').value,
                email: document.getElementById('new_email').value,
                phone: document.getElementById('new_phone').value,
                gender: document.getElementById('new_gender').value
            };
            fetch('/patient/request_update_otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(() => document.getElementById('otpOverlay').style.display = 'flex');
        }

        function verifyPatientUpdate() {
            fetch('/patient/verify_update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ otp: document.getElementById('p_otp_code').value })
            }).then(() => window.location.reload());
        }
    </script>
</body>
</html>
